<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BOOMI AR</title>

  <!-- A-Frame 與 AR.js 套件 -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .hint-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      pointer-events: none;
    }

    .hint-text div {
      color: white;
      font-size: 1.5em;
      text-shadow: 0 0 3px rgb(142, 142, 142);
    }

    #boomigameboy, #vid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      z-index: 9998;
      pointer-events: none;
      display: none;
    }
  </style>
</head>

<body>

  <!-- 提示文字區 -->
  <div class="hint-text" id="scanHint"><div>鏡頭對著數學作業封面會有驚喜喔！</div></div>
  <div class="hint-text" id="clickHint"><div>點一下畫面開始播放影片</div></div>
  <div class="hint-text" id="photoHint" style="display: none;"><div>按截圖鍵即可跟 BOOMI 拍照</div></div>

  <!-- 疊加影像與影片 -->
  <img id="boomigameboy" src="https://joyce103081.github.io/mathbook_ar_project/gameboy.png" />
  <video id="vid" src="https://joyce103081.github.io/mathbook_ar_project/ALL0623-1.mp4"
         preload="auto" loop="false" playsinline webkit-playsinline muted></video>

  <!-- A-Frame AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; precision: mediump"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false"
  >
    <a-assets>
      <img id="smile" src="https://joyce103081.github.io/mathbook_ar_project/smile.png" crossorigin="anonymous"/>
    </a-assets>

    <a-nft videohandler
      type="nft"
      url="https://joyce103081.github.io/mathbook_ar_project/mathbooktry3"
      smooth="true"
      smoothCount="100"
      smoothTolerance="0.08"
      smoothThreshold="10">
    </a-nft>

    <a-entity camera="far: 3000" position="0 0 0"></a-entity>
  </a-scene>

  <script>
    AFRAME.registerComponent("videohandler", {
      init: function () {
        const marker = this.el;
        const vid = document.getElementById("vid");
        const gameboy = document.getElementById("boomigameboy");
        const scanHint = document.getElementById("scanHint");
        const clickHint = document.getElementById("clickHint");
        const photoHint = document.getElementById("photoHint");
        let boomiImage = null;

        scanHint.style.display = "flex";
        clickHint.style.display = "none";

        marker.addEventListener("markerFound", () => {
          scanHint.style.display = "none";
          clickHint.style.display = "flex";
          vid.style.display = "block";
          gameboy.style.display = "block";
          vid.currentTime = 0;
          vid.muted = true;
        });

        marker.addEventListener("markerLost", () => {
          vid.pause();
          vid.currentTime = 0;
          vid.style.display = "none";
          gameboy.style.display = "none";
          clickHint.style.display = "none";
          photoHint.style.display = "none";
          if (boomiImage) {
            boomiImage.parentNode.removeChild(boomiImage);
            boomiImage = null;
          }
          scanHint.style.display = "flex";
        });

        document.body.addEventListener("click", () => {
          if (!vid.paused && !vid.ended) return;
          if (vid.style.display === "block") {
            vid.muted = false;
            vid.play();
            clickHint.style.display = "none";
          }
        });

        vid.addEventListener("ended", () => {
          vid.style.display = "none";
          gameboy.style.display = "none";

          boomiImage = document.createElement("a-image");
          boomiImage.setAttribute("src", "#smile");
          boomiImage.setAttribute("rotation", "0 0 0");
          boomiImage.setAttribute("width", "298");
          boomiImage.setAttribute("height", "420");
          boomiImage.setAttribute("look-at", "[camera]");

          const screenWidth = window.innerWidth;
          const screenHeight = window.innerHeight;
          const isPortrait = screenHeight > screenWidth;

          if (screenWidth < 768) {
            boomiImage.setAttribute("position", "-150 0 -1200");
          } else if (screenWidth < 1025) {
            boomiImage.setAttribute("position", isPortrait ? "-450 0 -1200" : "-300 0 -1000");
          } else {
            boomiImage.setAttribute("position", isPortrait ? "-400 100 -1300" : "-150 100 -1200");
          }

          document.querySelector("a-scene").appendChild(boomiImage);
          photoHint.style.display = "flex";
          setTimeout(() => {
            photoHint.style.display = "none";
          }, 10000);
        });
      }
    });
  </script>
</body>
</html>
