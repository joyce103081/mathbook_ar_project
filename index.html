<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BOOMI AR</title>

  <!-- A-Frame 與 AR.js 套件 -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .hint-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      pointer-events: none;
    }
    .hint-text div {
      color: white;
      font-size: 1.5em;
      text-shadow: 0 0 3px rgb(142, 142, 142);
    }
    #shutterBtn, #restartBtn {
      position: absolute;
      bottom: 40px;
      right: 40px;
      z-index: 9999;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background-color: rgba(255, 255, 255, 0.8);
      display: none;
      cursor: pointer;
    }
    #restartBtn {
      bottom: 100px;
    }
  </style>
</head>
<body>

  <!-- 提示文字區 -->
  <div class="hint-text" id="scanHint"><div>鏡頭對著數學作業簿封面會有驚喜喔！</div></div>
  <div class="hint-text" id="clickHint" style="display: none"><div>點一下畫面開始播放影片</div></div>
  <div class="hint-text" id="photoHint" style="display: none"><div>按截圖鍵即可跟 BOOMI 拍照</div></div>

  <!-- 拍照與重啟按鈕 -->
  <button id="shutterBtn">📸 拍照</button>
  <button id="restartBtn">🎬 影片</button>

  <!-- AR 場景 -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; precision: mediump"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false">

    <a-assets>
      <!-- 載入影片與圖片資源 -->
      <video id="vid" src="https://joyce103081.github.io/mathbook_ar_project/ALL2.0.mp4" preload="auto" loop="false" crossorigin="anonymous" playsinline muted></video>
      <img id="smile" src="https://joyce103081.github.io/mathbook_ar_project/smile.png" crossorigin="anonymous" />
    </a-assets>

    <!-- NFT Marker + AR 元件 -->
    <a-nft id="marker" videohandler type="nft" url="https://joyce103081.github.io/mathbook_ar_project/mathbooktry3" smooth="true">
      <a-video id="boomivid" src="#vid" rotation="-90 0 0" position="50 -100 -150" width="210" height="124" visible="false"></a-video>
      <a-image id="boomismile" src="#smile" rotation="-90 0 0" position="50 -100 -150" width="298" height="420" visible="false"></a-image>
    </a-nft>

    <!-- 相機 -->
    <a-entity camera="far: 3000" position="0 0 0"></a-entity>
  </a-scene>

  <script>
    // 📱 根據裝置調整顯示比例
    function adjustViewByDevice() {
      const scene = document.querySelector("a-scene");
      const isMobile = /iPhone|Android/i.test(navigator.userAgent);
      const isTablet = /iPad|Tablet|Nexus 7|Nexus 10/i.test(navigator.userAgent);
      const isPortrait = window.innerHeight > window.innerWidth;
      const isDesktop = !isMobile && !isTablet;

      scene.style.transform = "";
      scene.style.transformOrigin = "";

      if (isMobile) {
        scene.style.transform = "scale(1) translateY(-20px) translateX(10px)";
      } else if (isTablet) {
        scene.style.transform = isPortrait ?
          "scale(1.3) translateY(-150px) translateX(350px) translateZ(-1300px)" :
          "scale(1.4) translateY(-40px) translateX(150px) translateZ(-700px)";
      } else if (isDesktop) {
        scene.style.transform = isPortrait ?
          "scale(1.4) translateY(-200px) translateX(300px) translateZ(-1000px)" :
          "scale(1.6) translateY(-200px) translateX(200px) translateZ(-700px)";
      }

      scene.style.transformOrigin = "top center";
    }

    window.addEventListener("DOMContentLoaded", adjustViewByDevice);
    window.addEventListener("resize", adjustViewByDevice);

    const scanHint = document.getElementById("scanHint");
    const clickHint = document.getElementById("clickHint");
    const photoHint = document.getElementById("photoHint");
    const shutterBtn = document.getElementById("shutterBtn");
    const restartBtn = document.getElementById("restartBtn");

    let hasEnded = false;

    // 🎥 自訂 A-Frame component 控制流程
    AFRAME.registerComponent("videohandler", {
      init: function () {
        const marker = this.el;
        const vid = document.querySelector("#vid");
        const boomivid = document.querySelector("#boomivid");

        document.querySelector("a-scene").addEventListener("loaded", () => {
          scanHint.style.display = "flex";
        });

        marker.addEventListener("markerFound", () => {
          if (hasEnded) return;
          scanHint.style.display = "none";
          boomivid.setAttribute("visible", true);
          clickHint.style.display = "flex";
        });

        marker.addEventListener("markerLost", () => {
          if (hasEnded) return;
          vid.pause();
          vid.currentTime = 0;
          boomivid.setAttribute("visible", false);
          clickHint.style.display = "none";
        });

        document.body.addEventListener("click", () => {
          if (boomivid.getAttribute("visible") && vid.paused) {
            vid.muted = false;
            vid.play();
            clickHint.style.display = "none";
          }
        });

        vid.addEventListener("ended", () => {
          hasEnded = true;
          boomivid.setAttribute("visible", false);

          const boomiImage = document.createElement("a-image");
          boomiImage.setAttribute("src", "#smile");

          const screenWidth = window.innerWidth;
          const screenHeight = window.innerHeight;
          const isPortrait = screenHeight > screenWidth;

          // 根據裝置與方向調整顯示位置
          if (screenWidth < 768) {
            boomiImage.setAttribute("position", "-150 0 -1200");
          } else if (screenWidth < 1025) {
            boomiImage.setAttribute("position", isPortrait ? "-450 0 -1200" : "-300 0 -1000");
          } else {
            boomiImage.setAttribute("position", isPortrait ? "-400 100 -1300" : "-150 100 -1200");
          }

          boomiImage.setAttribute("rotation", "0 0 0");
          boomiImage.setAttribute("width", "298");
          boomiImage.setAttribute("height", "420");
          boomiImage.setAttribute("look-at", "[camera]");
          document.querySelector("a-scene").appendChild(boomiImage);

          photoHint.style.display = "flex";
          shutterBtn.style.display = "block";
          restartBtn.style.display = "block";

          setTimeout(() => {
            photoHint.style.display = "none";
          }, 10000);
        });

        // 🔁 重啟功能
        restartBtn.addEventListener("click", () => {
          hasEnded = false;
          boomivid.setAttribute("visible", false);
          scanHint.style.display = "flex";
          document.querySelectorAll("a-image[src='#smile']").forEach(img => img.remove());
          shutterBtn.style.display = "none";
          restartBtn.style.display = "none";
        });
      }
    });
  </script>
</body>
</html>
